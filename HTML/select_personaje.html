<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Selecciona tu Personaje</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#29B6F6",
                        "text-primary": "#29B6F6",
                        "text-secondary": "#6B7280",
                        "background": "#F9FAFB",
                        "card": "#FFFFFF",
                        "border": "#E5E7EB",
                        "accent": "#29B6F6"
                    },
                    fontFamily: {
                        "display": ["Public Sans", "sans-serif"]
                    },
                    boxShadow: {
                        "card": "0 4px 12px rgba(0,0,0,0.05)"
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    }
                },
            },
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
</head>

<body class="bg-white font-display">

    <div class="max-w-md mx-auto min-h-screen flex flex-col">

        <!-- HEADER -->
        <div class="sticky top-0 z-10 flex flex-col bg-white">
            <div class="flex items-center p-4 pb-2 justify-between">
                <button type="button" onclick="history.back()"
                    class="mr-2 flex size-12 shrink-0 items-center justify-start text-slate-800">
                    <span class="material-symbols-outlined !text-2xl">arrow_back</span>
                </button>
                <div class="flex-1 flex flex-col items-center">
                    <img src="/assets/img/elige_a_tu_candidato.png" alt="Logo" class="h-10 object-contain mb-1">
                </div>
                <div class="size-12 shrink-0"></div>
            </div>
        </div>

        <!-- MAIN -->
        <main class="p-4 flex-1">
            <p class="text-center text-gray-500 mb-4">¡Apoya a tu favorito y haz que llegue al top 10!</p>
            <div id="personajes-container" class="grid grid-cols-2 gap-4"></div>
        </main>

        <div id="site-footer"></div>

        <!-- FOOTER SCRIPT -->
        <script>
            fetch('footer.html')
                .then(r => r.ok ? r.text() : "")
                .then(html => document.getElementById("site-footer").innerHTML = html);
        </script>

        <!-- TARJETAS DE PERSONAJES -->
        <script>
            let personajes = [];

            // Limpiar voto si pasó 1 minuto
            (function() {
                const ultimoVoto = localStorage.getItem("ultimoVoto");
                const ahora = Date.now();
                const minuto = 1 * 60 * 1000;
                if (ultimoVoto && (ahora - ultimoVoto >= minuto)) {
                    localStorage.removeItem("ultimoVoto");
                }
            })();

            function cargarPersonajes() {
                fetch('https://api-nodepost-production.up.railway.app/candidatos')
                    .then(res => res.json())
                    .then(data => {
                        personajes = data.map(p => ({
                            id: p.id,
                            nombre: p.nombre,
                            foto_url: p.foto_url,
                            votos: p.votos ?? 0,
                            descripcion: p.descripcion ?? "Sin descripción"
                        }));
                        mostrarPersonajes();
                    })
                    .catch(err => console.error("Error cargando API:", err));
            }

            function mostrarPersonajes() {
                const cont = document.getElementById('personajes-container');
                cont.innerHTML = "";
                personajes.forEach(p => {
                    cont.innerHTML += `
                        <div class="card cursor-pointer bg-gray-900 rounded-lg p-2 flex flex-col gap-1"
                            onclick="seleccionarPersonaje(${p.id})">
                            <div class="card_form h-48 rounded-md bg-cover bg-center" style="background-image:url('${p.foto_url}')"></div>
                            <div class="card_data flex flex-col text-white">
                                <span class="text-m font-bold">${p.nombre}</span>
                                <span class="text-s text-sky-400">${p.descripcion}</span>
                            </div>
                        </div>
                    `;
                });
            }

            function seleccionarPersonaje(id) {
                const ultimoVoto = localStorage.getItem("ultimoVoto");
                const ahora = Date.now();
                const minuto = 1 * 60 * 1000;

                if (ultimoVoto) {
                    const tiempoTranscurrido = ahora - ultimoVoto;
                    if (tiempoTranscurrido < minuto) {
                        // Redirigir directo a ranking si sigue activo
                        window.location.href = "ranking.html";
                        return;
                    }
                }

                const personaje = personajes.find(p => p.id === id);
                if (!personaje) return;

                let votosLocal = JSON.parse(localStorage.getItem("votosLocal") || "{}");
                votosLocal[id] = (votosLocal[id] || 0) + 1;
                localStorage.setItem("votosLocal", JSON.stringify(votosLocal));

                localStorage.setItem("ultimoVoto", ahora);

                alert(`Has apoyado a ${personaje.nombre}`);
                window.location.href = "ranking.html";
            }

            cargarPersonajes();
        </script>

    </div>
</body>

</html>
